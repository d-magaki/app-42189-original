<h1 class="page-title">案件一覧</h1>

<% if current_user.管理者? %>
  <div class="d-flex flex-wrap gap-2 mb-3">
    <%= link_to "新規登録", new_project_path, class: "btn btn-success" %>
    <%= link_to "リスト分析", analytics_path, class: "btn btn-info" %>
    <%= form_with url: import_projects_path, method: :post, multipart: true, class: "d-flex align-items-center gap-2" do |form| %>
      <%= form.file_field :file, class: "form-control" %>
      <%= form.submit "Data Import", class: "btn btn-primary" %>
    <% end %>
  </div>
<% end %>

<div id="split-wrapper" style="height: 700px; display: flex; flex-direction: column;">
  <div class="list-container" style="overflow-x: auto;">
    <table id="projects-table" class="table table-striped table-bordered" style="min-width: 3000px; table-layout: fixed;">
      <thead>
        <tr>
          <th style="width: 160px;">顧客名</th>
          <th style="width: 140px;">営業拠点</th>
          <th style="width: 140px;">営業担当</th>
          <th style="width: 120px;">依頼種別</th>
          <th style="width: 150px;">依頼内容</th>
          <th style="width: 120px;">受注日</th>
          <th style="width: 120px;">納期</th>

          <% if current_user.管理者? %>
            <th style="width: 120px;">売上</th>
            <th style="width: 120px;">コスト</th>
            <th style="width: 120px;">利益</th>
          <% end %>

          <th style="width: 200px;">備考</th>
          <th style="width: 180px;">添付資料</th>

          <% if current_user.管理者? %>
            <th style="width: 120px;">担当社員ID</th>
            <th style="width: 140px;">担当社員名</th>
            <th style="width: 100px;">権限</th>
          <% else %>
            <th style="width: 120px;">社員ID</th>
            <th style="width: 140px;">担当者名</th>
          <% end %>

          <% if current_user.管理者? || current_user.department == "企画部" %>
            <th style="width: 140px;">企画開始</th>
            <th style="width: 140px;">企画完了</th>
          <% end %>
          <% if current_user.管理者? || current_user.department == "情報設計部" %>
            <th style="width: 140px;">設計開始</th>
            <th style="width: 140px;">設計完了</th>
          <% end %>
          <% if current_user.管理者? || current_user.department == "開発部" %>
            <th style="width: 140px;">開発開始</th>
            <th style="width: 140px;">開発完了</th>
          <% end %>

          <th style="width: 100px;">状態</th>
        </tr>
      </thead>

      <tbody>
        <% @projects.each do |project| %>
          <% next unless should_show_in_list?(project, current_user, @filter) %>

          <tr data-url="<%= project_path(project.id) %>">
            <td><%= project.customer_name %></td>
            <td><%= project.sales_office %></td>
            <td><%= project.sales_representative %></td>
            <td><%= project.request_type %></td>
            <td><%= project.request_content %></td>
            <td><%= project.order_date %></td>
            <td><%= project.due_date %></td>

            <% if current_user.管理者? %>
              <td><%= number_with_delimiter(project.revenue) %> 円</td>
              <td><%= number_with_delimiter(project.cost) %> 円</td>
              <td><%= number_with_delimiter(project.profit) %> 円</td>
            <% end %>

            <td><%= project.remarks %></td>
            <td>
              <% if project.attachments.attached? %>
                <% project.attachments.each do |attachment| %>
                  <%= link_to attachment.filename.to_s, rails_blob_path(attachment, disposition: "inline"), target: "_blank" %><br>
                <% end %>
              <% else %>なし<% end %>
            </td>

            <%# 担当者表示切替 %>
            <% if current_user.管理者? %>
              <% user = User.find_by(id: project.planning_user_id || project.design_user_id || project.development_user_id) %>
              <td><%= user&.employee_id || "未設定" %></td>
              <td><%= user&.user_name || "未設定" %></td>
              <td><%= user&.role == "管理者" ? "管理者" : "一般社員" %></td>
            <% elsif current_user.department == "企画部" %>
              <% user = User.find_by(id: project.planning_user_id) %>
              <td><%= user&.employee_id || "未設定" %></td>
              <td><%= user&.user_name || "未設定" %></td>
            <% elsif current_user.department == "情報設計部" %>
              <% user = User.find_by(id: project.design_user_id) %>
              <td><%= user&.employee_id || "未設定" %></td>
              <td><%= user&.user_name || "未設定" %></td>
            <% elsif current_user.department == "開発部" %>
              <% user = User.find_by(id: project.development_user_id) %>
              <td><%= user&.employee_id || "未設定" %></td>
              <td><%= user&.user_name || "未設定" %></td>
            <% end %>

            <% if current_user.管理者? || current_user.department == "企画部" %>
              <td><%= project.planning_start_date %></td>
              <td><%= project.planning_end_date %></td>
            <% end %>
            <% if current_user.管理者? || current_user.department == "情報設計部" %>
              <td><%= project.design_start_date %></td>
              <td><%= project.design_end_date %></td>
            <% end %>
            <% if current_user.管理者? || current_user.department == "開発部" %>
              <td><%= project.development_start_date %></td>
              <td><%= project.development_end_date %></td>
            <% end %>

            <td><%= project.status %></td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>

  <!-- 担当件数下部エリア -->
  <div class="chart-container p-3 bg-light" style="overflow: auto;">
    <div class="mt-3">
      <h5 class="fw-bold mb-3">社員別 担当案件数</h5>
      <table class="table table-bordered w-auto">
        <thead class="table-primary">
          <tr>
            <th>社員名</th>
            <th>担当件数</th>
          </tr>
        </thead>
        <tbody>
          <% @employee_tasks.each do |user, count| %>
            <% if count > 0 %>
              <tr>
                <td><%= user.user_name %></td>
                <td><%= count %> 件</td>
              </tr>
            <% end %>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>
</div>
