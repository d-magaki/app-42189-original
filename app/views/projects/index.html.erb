<h1 class="page-title">案件一覧</h1>

<div class="mb-3">
  <div class="btn-group" role="group" aria-label="フィルター">
    <%= link_to "未着手", projects_path(filter: "unstarted"), class: "btn btn-outline-primary #{'active' if @filter == 'unstarted'}" %>
    <%= link_to "作業中", projects_path(filter: "in_progress"), class: "btn btn-outline-primary #{'active' if @filter == 'in_progress'}" %>
    <%= link_to "全体", projects_path(filter: "all"), class: "btn btn-outline-secondary #{'active' if @filter == 'all'}" %>
  </div>
</div>

<% if current_user.admin? %>
  <div class="d-flex flex-wrap gap-2 mb-3">
    <%= link_to "新規登録", new_project_path, class: "btn btn-success" %>
    <%= link_to "リスト分析", analytics_path, class: "btn btn-info" %>
    <%= form_with url: import_projects_path, method: :post, multipart: true, class: "d-flex align-items-center gap-2" do |form| %>
      <%= form.file_field :file, class: "form-control" %>
      <%= form.submit "Data Import", class: "btn btn-primary" %>
    <% end %>
  </div>
<% end %>

<div id="split-wrapper" style="height: 700px; display: flex; flex-direction: column;">
  <div class="list-container" style="overflow-x: auto;">
    <table id="projects-table" class="table table-striped table-bordered" style="min-width: 3000px; table-layout: fixed;">
      <thead>
        <tr>
          <th>顧客名</th>
          <th>営業拠点</th>
          <th>営業担当</th>
          <th>依頼種別</th>
          <th>依頼内容</th>
          <th>受注日</th>
          <th>納期</th>

          <% if current_user.admin? %>
            <th>売上</th>
            <th>コスト</th>
            <th>利益</th>
          <% end %>

          <th>備考</th>
          <th>添付資料</th>

          <% if current_user.admin? %>
            <th>企画担当者</th>
            <th>設計担当者</th>
            <th>開発担当者</th>
          <% elsif current_user.planning? %>
            <th>企画担当者</th>
          <% elsif current_user.design? %>
            <th>設計担当者</th>
          <% elsif current_user.development? %>
            <th>開発担当者</th>
          <% end %>

          <% if current_user.admin? || current_user.planning? %>
            <th>企画開始日</th>
            <th>企画完了日</th>
          <% end %>
          <% if current_user.admin? || current_user.design? %>
            <th>設計開始日</th>
            <th>設計完了日</th>
          <% end %>
          <% if current_user.admin? || current_user.development? %>
            <th>開発開始日</th>
            <th>開発完了日</th>
          <% end %>

          <th>状態</th>
        </tr>
      </thead>

      <tbody>
        <% @projects.each do |project| %>
          <% next unless should_show_in_list?(project, current_user, @filter) %>

          <tr data-url="<%= project_path(project.id) %>">
            <td><%= project.customer_name %></td>
            <td><%= project.sales_office %></td>
            <td><%= project.sales_representative %></td>
            <td><%= project.request_type %></td>
            <td><%= project.request_content %></td>
            <td><%= project.order_date %></td>
            <td><%= project.due_date %></td>

            <% if current_user.admin? %>
              <td><%= number_with_delimiter(project.revenue) %> 円</td>
              <td><%= number_with_delimiter(project.cost) %> 円</td>
              <td><%= number_with_delimiter(project.profit) %> 円</td>
            <% end %>

            <td><%= project.remarks %></td>
            <td>
              <% if project.attachments.attached? %>
                <% project.attachments.each do |attachment| %>
                  <%= link_to attachment.filename.to_s, rails_blob_path(attachment, disposition: "inline"), target: "_blank" %><br>
                <% end %>
              <% else %>なし<% end %>
            </td>

            <% if current_user.admin? %>
              <td><%= User.find_by(id: project.planning_user_id)&.user_name || "未設定" %></td>
              <td><%= User.find_by(id: project.design_user_id)&.user_name || "未設定" %></td>
              <td><%= User.find_by(id: project.development_user_id)&.user_name || "未設定" %></td>
            <% elsif current_user.planning? %>
              <td><%= User.find_by(id: project.planning_user_id)&.user_name || "未設定" %></td>
            <% elsif current_user.design? %>
              <td><%= User.find_by(id: project.design_user_id)&.user_name || "未設定" %></td>
            <% elsif current_user.development? %>
              <td><%= User.find_by(id: project.development_user_id)&.user_name || "未設定" %></td>
            <% end %>

            <% if current_user.admin? || current_user.planning? %>
              <td><%= project.planning_start_date %></td>
              <td><%= project.planning_end_date %></td>
            <% end %>
            <% if current_user.admin? || current_user.design? %>
              <td><%= project.design_start_date %></td>
              <td><%= project.design_end_date %></td>
            <% end %>
            <% if current_user.admin? || current_user.development? %>
              <td><%= project.development_start_date %></td>
              <td><%= project.development_end_date %></td>
            <% end %>

            <td><%= project.status %></td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>

  <div class="chart-container p-3 bg-light" style="overflow: auto;">
    <div class="mt-3">
      <h5 class="fw-bold mb-3">社員別 担当案件数</h5>
      <table class="table table-bordered w-auto">
        <thead class="table-primary">
          <tr>
            <th>社員名</th>
            <th>担当件数</th>
          </tr>
        </thead>
        <tbody>
          <% @employee_tasks.each do |user, count| %>
            <% if count > 0 %>
              <tr>
                <td><%= user.user_name %></td>
                <td><%= count %> 件</td>
              </tr>
            <% end %>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>
</div>
